<head>

    @manifest {
        title: "SVG to game object";
        favicon: "/assets/soul.png";
    }
    
    @resources {
        ls-js: tiny;
    }

</head>

<body>
    <main>
        <h2>This tool will help you convert a SVG into game objects.</h2>
        <input onchange="handleFileSelect(this)" type="file" %svg>

        <br> <br>
        
        <div %result hidden>
            <pre>
                <code %preview></code>
            </pre> <br>
            <button onclick="copy()">Copy result</button>
        </div>
    </main>

    <style>
        pre {
        background: #000;
        color: #fff;
        max-height: 400px;
        overflow: auto;
    }
    </style>

    <script>
        function svgToObjects(svgString) {
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(svgString, "image/svg+xml");

            const rects = svgDoc.querySelectorAll("rect");

            const rectObjects = Array.from(rects).map(rect => {
                // Get basic attributes
                let x = Math.round(parseFloat(rect.getAttribute("x")))
                let y = Math.round(parseFloat(rect.getAttribute("y")))
                let width = Math.round(parseFloat(rect.getAttribute("width")))
                let height = Math.round(parseFloat(rect.getAttribute("height")))

                const transform = rect.getAttribute("transform");
                if (transform && transform.includes("rotate")) {
                    // Extract rotation angle and optional pivot point
                    const rotateMatch = /rotate\(([\d.-]+)\s([\d.-]+)\s([\d.-]+)\)/.exec(transform);
                    if (rotateMatch) {
                        const angle = parseFloat(rotateMatch[1]);
                        const cx = parseFloat(rotateMatch[2]);
                        const cy = parseFloat(rotateMatch[3]);

                        // Apply the rotation transform
                        ({ x, y, width, height } = applyRotation(x, y, width, height, angle, cx, cy));
                    }
                }

                return { solid: rect.getAttribute("fill").toLowerCase() === "#ff0000", x, y, width, height };
            });

            return rectObjects;
        }

        let result;

        function copy(){
            LS.Util.copy(JSON.stringify(result))
        }

        // Yes, the follownig code is AI generated and may not meet the standard, I just didnt want to spend too much time on this misc feature.

        function applyRotation(x, y, width, height, angle, cx, cy) {
            const radians = (Math.PI / 180) * angle;

            const points = [
                rotatePoint(x, y, radians, cx, cy),               // Top-left
                rotatePoint(x + width, y, radians, cx, cy),       // Top-right
                rotatePoint(x, y + height, radians, cx, cy),      // Bottom-left
                rotatePoint(x + width, y + height, radians, cx, cy) // Bottom-right
            ];

            const xs = points.map(p => p.x);
            const ys = points.map(p => p.y);
            const newX = Math.min(...xs);
            const newY = Math.min(...ys);
            const newWidth = Math.max(...xs) - newX;
            const newHeight = Math.max(...ys) - newY;

            return { x: Math.round(newX), y: Math.round(newY), width: Math.round(newWidth), height: Math.round(newHeight) };
        }

        function rotatePoint(px, py, radians, cx, cy) {
            const cos = Math.cos(radians);
            const sin = Math.sin(radians);

            const translatedX = px - cx;
            const translatedY = py - cy;

            const rotatedX = translatedX * cos - translatedY * sin;
            const rotatedY = translatedX * sin + translatedY * cos;

            const finalX = rotatedX + cx;
            const finalY = rotatedY + cy;

            return { x: finalX, y: finalY };
        }

        function handleFileSelect(inputElement) {
            const file = inputElement.files[0];

            if (!file) {
                console.error("No file selected");
                return;
            }

            const reader = new FileReader();

            reader.onload = function (e) {
                const svgString = e.target.result;

                const rectsArray = svgToObjects(svgString);

                O("#result").show()
                O("#preview").innerText = JSON.stringify(rectsArray, null, 4)

                console.log(rectsArray);

                result = rectsArray;
            };

            reader.readAsText(file);

            inputElement.value = '';
        }
    </script>
</body>